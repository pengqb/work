# 加密算法 #

HTTPS一般使用的加密与HASH算法如下：
非对称加密算法：RSA[1]，DSA/DSS
对称加密算法：AES，RC4，3DES
HASH算法：MD5，SHA1，SHA256
其中非对称加密算法用于在握手过程中加密生成的密码，对称加密算法用于对真正传输的数据进行加密，而HASH算法用于验证数据的完整性。

# 数字证书（Certificate） #

在数字证书使用过程中，会遇到签发证书问题，一般来说，有3个解决方法：
1.交由受信任的第三方证书颁发机构签名，CA签名的证书可以被吊销；
2.自签名，自签名的证书无法被吊销；
3.自制CA证书并用其签名，CA签名的证书可以被吊销。
对于上线运营的网站来说，第一个方案是首选，因为只有这样浏览器才不会报警。过去买证书很贵，现在倒是有免费的了，比如IE和Firefox都支持的StartSSL。
如果你的规划需要创建多个证书，那么使用自制CA的方法比较合适，因为只要给所有的客户端都安装了CA的证书，那么以该证书签名过的证书，客户端都是信任的，也就是安装一次就够了。
如果你直接用自签名证书，你需要给所有的客户端安装该证书才会被信任，如果你需要第二个证书，则还的挨个给所有的客户端安装证书2才会被信任。

X.509证书包含四个文件：key，csr，crt，p12。
key是服务器上的私钥文件，用于对发送给客户端数据的加密，以及对从客户端接收到数据的解密
csr是证书签名请求文件，用于提交给证书颁发机构（CA）对证书签名
crt是由证书颁发机构（CA）签名后的证书，或者是开发者自签名的证书，包含证书持有人的信息，持有人的公钥，以及签署者的签名等信息
p12 证书，包含一个X509证书和一个被密码保护的私钥
备注：在密码学中，X.509是一个标准，规范了公开秘钥认证、证书吊销列表、授权凭证、凭证路径验证算法等。

密钥库编码格式有两种
1.PEM(Privacy-enhanced Electronic Mail) 是明文格式的  以 -----BEGIN CERTIFICATE-----开头，以-----END CERTIFICATE-----结尾，中间是经过base64编码的内容,apache需要的证书就是这类编码的证书 查看这类证书的信息的命令为 ：

  	openssl rsa -inform PEM -noout -text -in  prikey.pem
	openssl rsa -inform PEM -noout -text -pubin -in pubkey.pem

其实PEM就是把DER的内容进行了一次base64编码
2.DER 是二进制格式的证书   查看这类证书的信息的命令为 ：

	openssl rsa -inform DER  -noout -text -in  xxx.der
    
# 创建自签名证书的步骤 #
注意：以下步骤仅用于配置内部使用或测试需要的SSL证书。

## 第1步：生成私钥 ##
使用openssl工具生成一个RSA私钥

    $ openssl genrsa -des3 -out prikey.pem 2048

说明：生成rsa私钥，des3算法，2048位强度，prikey.pem是秘钥文件名，对应X.509证书里的*.key文件。

注意：生成私钥，需要提供一个至少4位的密码。

## 第2步：生成CSR（证书签名请求） ##
生成私钥之后，便可以创建csr文件了。

此时可以有两种选择。理想情况下，可以将证书发送给证书颁发机构（CA），CA验证过请求者的身份之后，会出具签名证书（很贵）。另外，如果只是内部或者测试需求，也可以使用OpenSSL实现自签名，具体操作如下：

    $ openssl req -new -key prikey.pem -out server.csr

说明：需要依次输入国家，地区，城市，组织，组织单位，Common Name和Email。其中Common Name，可以写自己的名字或者域名，如果要支持https，Common Name应该与域名保持一致，否则会引起浏览器警告。

    Country Name (2 letter code) [XX]:CN
    State or Province Name (full name) []:Zhejiang  
    Locality Name (eg, city) [Default City]:Hangzhou
    Organization Name (eg, company) [Default Company Ltd]:Vane
    Organizational Unit Name (eg, section) []:it
    Common Name (eg, your name or your server's hostname) []:*.vanelife.com
    Email Address []:pengqiangbing@vanelife.com

## 第3步：删除私钥中的密码 ##
在第1步创建私钥的过程中，由于必须要指定一个密码。而这个密码会带来一个副作用，那就是在每次Apache启动Web服务器时，都会要求输入密码，这显然非常不方便。要删除私钥中的密码，操作如下：

    cp prikey.pem prikey.pem.pw
    openssl rsa -in prikey.pem.pw -out prikey.pem

## 第4步：生成自签名证书 ##
如果你不想花钱让CA签名，或者只是测试SSL的具体实现。那么，现在便可以着手生成一个自签名的证书了。

需要注意的是，在使用自签名的临时证书时，浏览器会提示证书的颁发机构是未知的。

    $ openssl x509 -req -days 3650 -in server.csr -signkey prikey.pem -out server.crt

说明：crt上有证书持有人的信息，持有人的公钥，以及签署者的签名等信息。当用户安装了证书之后，便意味着信任了这份证书，同时拥有了其中的公钥。证书上会说明用途，例如服务器认证，客户端认证，或者签署其他证书。当系统收到一份新的证书的时候，证书会说明，是由谁签署的。如果这个签署者确实可以签署其他证书，并且收到证书上的签名和签署者的公钥可以对上的时候，系统就自动信任新的证书。

## 第5步：安装私钥和证书 ##
将私钥和证书文件复制到Apache的配置目录下即可，在Mac 10.10系统中，复制到/etc/apache2/目录中即可。

# 二.创建私有CA,然后用该CA给证书进行签名 #

## 1.创建CA私钥  ## 

    openssl genrsa -des3 -out ca.key 4096

## 2.生成CA的自签名证书  ##  

	openssl req -new -x509 -days 3650 -key ca.key -out ca.crt   

其实CA证书就是一个自签名证书

## 3.用创建的CA证书给上面生成的签名请求进行签名 ##

    openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server_ca.crt

# 证书验证 #
## 使用自制CA证书进行验证 ##

    openssl s_server -accept 4433 -cert ./server_ca.crt -key prikey.pem

-accept port：监听的TCP端口。缺省为4433。
-cert filename：使用的证书文件名。大多数服务器算法套件需要一个证书，还有一些需要证书的公钥类型，例如DSS算法组件需要证书（包含一个DSS（DSA）密钥）。缺省使用 ./server.pem。
-key filename：使用的私有密钥文件。如果没有指定，那么证书文件会被使用（使用的是证书公钥值）。
   
	openssl s_client -connect localhost:4433 -CAfile ./ca.crt 

模拟一个ssl客户端访问ssl服务器  
-CAfile filename：某文件，里面是所有你信任的CA的证书的内容。当你要建立client的证书链的时候也需要用到这个文件。

返回结果，表示验证通过：

    Verify return code: 0 (ok)

如果不使用自制CA证书进行验证，则报如下错误：

    openssl s_client -connect localhost:4433
    Verify return code: 21 (unable to verify the first certificate)


## 使用自签名证书进行验证 ##

    openssl s_server -accept 4433 -cert ./server.crt -key prikey.pem
    openssl s_client -connect localhost:4433 -CAfile ./server.crt

返回结果，表示验证通过：

    Verify return code: 0 (ok)

# 常用签名命令 #

    openssl rsa -noout -text -in prikey.pem 查看私钥信息
    openssl req -noout -text -in server.csr 查看签名请求信息
    openssl x509 -noout -text -in server.crt  查看证书信息
    openssl x509 -purpose -in server.crt 查看一个证书的额外信息
    openssl rsa -in prikey.pem -pubout -out pubkey.pem 从一个私钥里面提取出公钥
    openssl rsa -noout -text -pubin -in pubkey.pem  查看一个公钥的信息
    openssl verify -CAfile ca.crt server_ca.crt  验证一个证书是否是某一个CA签发

注意ca根证书和被验签的证书必须是不同的组织，否则被认为是自签名证书，报下面的错误：[2][3]

    server_ca.crt: C = CN, ST = Zhejiang, L = Hangzhou, O = Vane, OU = it, CN = *.vanelife.com, emailAddress = pengqiangbing@vanelife.com
    error 18 at 0 depth lookup:self signed certificate
    OK

# OpenSSL心脏出血漏洞 #
有关心脏出血漏洞

	http://www.freebuf.com/articles/network/32171.html

可以通过下面的工具测试你的url是否有心脏出血漏洞

    https://filippo.io/Heartbleed/#api.vanelife.com:443

# keytool工具 #
Keytool 是一个Java数据证书的管理工具，和openssl类似。

## 一、生成证书 ##
    keytool -genkey -alias michaelkey -keyalg RSA -keysize 1024 -keypass 123456 -validity 365 -keystore /app/ssl/michael.keystore -storepass 123456

## 二、查看证书 ##
缺省情况下，-list 命令打印证书的 MD5 指纹。而如果指定了 -v 选项，将以可读格式打印证书，如果指定了 -rfc 选项，将以可打印的编码格式输出证书。

-v 命令如下：

    keytool -list -rfc -keystore /app/ssl/michael.keystore -storepass 123456
-rfc 命令如下：

    keytool -list -rfc -keystore /app/ssl/michael.keystore -storepass 123456

## 三、导出证书 ##
    keytool -export -alias michaelkey -keystore /app/ssl/michael.keystore -file /app/ssl/michael.crt -storepass 123456

## 四、查看证书 ##
    keytool -printcert -file /app/ssl/michael.crt


# 参考 #
[1]http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html
[2]http://blog.csdn.net/as3luyuan123/article/category/1743855
[3]http://man.linuxde.net/openssl