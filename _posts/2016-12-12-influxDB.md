# 一、从以下位置下载对应版本的influxdb #
https://www.influxdata.com/downloads/


# 二、influxdb-1.1.1_windows_amd64.zip解压 #

将当前目录下的influxdb-1.1.1_windows_amd64.zip解压到本地磁盘某个目录下.如E:\green\influxdb-1.1.1-1。

# 三、设置环境变量 #

新增环境变量

    HOME = E:\green\influxdb-1.1.1-1

修改环境变量

    Path = Path + E:\green\influxdb-1.1.1-1;

# 四、启动服务器 #
在控制台执行

    C:\Users\pengqb>influxd

# 五、启动客户端 #
在控制台执行

    C:\Users\pengqb>influx

客户端显示数据库

    > show databases
    name: databases
    name
    ----
    _internal
    mydb

    > use mydb
    Using database mydb

# 六、语法 #

|Element	 |Optional/Required		|Description|Type|
|----------------------------------------------------|
|Measurement |Required |The measurement name. InfluxDB accepts one measurement per point           |String  	 |
|Tag set 	 |Optional|All tag key-value pairs for the point |Tag keys and tag values are both strings|
|Field set 	 |Required.Points must have at least one field |All field key-value pairs for the point |Field keys are strings. Field values can be floats, integers, strings, or booleans.  	 |
|Timestamp	 |Optional.InfluxDB uses the server’s local nanosecond timestamp in UTC if the timestamp is not included with the point |The timestamp for the data point. InfluxDB accepts one timestamp per point|Unix nanosecond timestamp. Specify alternative precisions with the HTTP API |



# 七、存储引擎 #
演化

LSM Tree(LevelDB) ===> LMDB(BoltDB) ===> TSM Tree(tsm)

介绍TSM

# 八、保留策略（retention policy） #
InfluxDB本身不提供数据的删除操作，因此用来控制数据量的方式就是定义数据保留策略。

Influxdb 的数据存储可以支持多碎片空间（Shard Space），每个碎片空间可以是一种存储引擎。
每个碎片碎片空间都有下面属性，跟上面图的内容项对应：

    {
      "name": "high_precision",
      "database": "pauls_db",
      "retentionPolicy": "7d",
      "shardDuration": "1d",
      "regex": "/^[a-z].*/",
      "replicationFactor": 1,
      "split": 1
    }

在配置参数中， 我们可以看到 "database": "pauls_db" 表示 每个碎片空间都只能属于一个特定的数据库，一个数据库可以有多个碎片空间。
"retentionPolicy": "7d" 表示数据被保存的时间（最少保存时间）， inf 表示永久保存。

DURATION可以写1h, 90m, 12h, 7d, 4w意为 1 hour, 90minutes, 12 hours, 7 days, 4 weeks，经过测试，用户至少可以设置1h，而最大可以使用“INF”来告诉数据库所有的数据永久保留。 

shardDuration 的值应该小于 retentionPolicy， 大于我们查询时的group by time() 的值。
上面配置的例子中 "retentionPolicy": "7d", "shardDuration": "1d",   会导致我们保存 7天的数据， 每天都会清理，把7天前的数据清理掉一次。
"replicationFactor": 1,  每个存储碎片保存到几台服务器的设置；
"split": 1 给定的时间间隔内，有多少个存储碎片。
注意，这里有下面一个隐含的关系： replicationFactor * split == 服务器的数量。
数据被分配到那个碎片空间是基于下面的算法：
Look up the shard spaces for the InfluxDB database
Loop through the spaces and use the first one that matches the series name
Lookup the shards for the given time interval
If no shards exist, create N shards for the interval based on split
Assign the data to a given shard in the interval using the algorithm  hash(series_name) % N

查看策略

    SHOW RETENTION POLICIES ON <database>
    > SHOW RETENTION POLICIES ON write_1481590173409
    name	duration	shardGroupDuration  replicaN	default
    ------------------------------  ---------------
    autogen 0s  		168h0m0s			1   		true

可以看到，telegraf只有一个策略，各字段的含义如下：

- name--名称，此示例名称为 autogen
- duration--数据存储持续时间，0代表无限制。Data older than the duration are automatically dropped from the database。
- shardGroupDuration--shardGroup的存储时间，shardGroup是InfluxDB的一个基本储存结构，应该大于这个时间的数据在查询效率上应该有所降低。
- replicaN--全称是REPLICATION，副本个数，单节点时该参数无效
- default--是否是默认策略

新增策略

	CREATE RETENTION POLICY <retentionpolicy>  
       ON <database>  
       DURATION <duration>  
       REPLICATION <n>  
	   [SHARD DURATION <duration>]
       [DEFAULT] 

	CREATE RETENTION POLICY write7d ON write_1481590173409 DURATION 7d REPLICATION 1 SHARD DURATION 7d DEFAULT

修改策略

    ALTER RETENTION POLICY <retentionpolicy>  
       ON <database>  
       [DURATION <duration>]  
       [REPLICATION<n>] 
	   [SHARD DURATION <duration>]
       [DEFAULT]

删除策略
    
    DROP RETENTION POLICY <retentionpolicy> ON <database>


# 九、性能提示： #

    Sort tags by key before sending them to the database. The sort should match the results from the Go bytes.Compare function.
    Use the coarsest precision possible for timestamps. This can result in significant improvements in compression.

**硬件需求**

|负载|	写/秒|	读/秒|	唯一系列|
|------------------------------|
|低	|< 5千|	< 5|	< 10万|
|标准|	< 10万|	< 25|	< 100万|
|高|	> 10万|	> 25|	> 100万|
|极限|	50万	|100|	1000万|

低配
CPU: 2-4核；RAM: 2-4 GB；IOPS: 500；

标配
CPU: 4-6核；RAM: 8-32 GB；IOPS: 500-1000；

高
CPU: 8核+；RAM: 32+ GB；IOPS: 1000+

## 本地实测性能 ##

    Single Point Write for 100000 writes of Points took:2.662 s
    Single Point Write for 100000 writes of Points took:2.564 s
    
    WritePoints for 1 writes of 100000 Points took:2.399 s
    WritePoints for 1 writes of 100000 Points took:2.291 s
    WritePoints for 1 writes of 100000 Points took:2.368 s
    
    2Mio points:6.882 s
    2Mio points:6.606 s

# 十、高可用性 #

## Clustering ##

Open-source InfluxDB does not support clustering. For high availability or horizontal scaling of InfluxDB, please investigate InfluxEnterprise.
据七牛架构师反映 InfluxDB自带的集群功能不稳定

## Relay ##
Relay adds a basic high availability layer to InfluxDB. With the right architecture and disaster recovery processes, this achieves a highly available setup.

## 安装influxdb-relay ##
https://github.com/influxdata/influxdb-relay
influxdb开源的集群以及高可用服务都不是很完善，不建议在生产环境中使用
http://blog.itpub.net/26250550/viewspace-2129322/
http://geek.csdn.net/news/detail/77925?utm_source=tuicool&utm_medium=referral

## 备份与增量备份 ##

    influxd backup -database write_1481590173409 -retention autogen -since 2016-12-01T00:00:00Z /tmp/backup

-since <date> - This flag can be used to create a backup since a specific date, where the date must be in RFC3339 format (for example, 2015-12-24T08:12:23Z). This flag is important if you would like to take incremental backups of your database. If not specified, all timeranges within the database will be backed up.



# 十、问题 #
1、influxDB如何象mysql删除分区一样快速删除记录？
InfluxDB本身不提供数据的删除操作，因此用来控制数据量的方式就是定义数据保留策略（retention policy）。让InfluxDB能够知道可以丢弃哪些数据，从而更高效的处理数据。
    

2、HTTP连接和UDP连接性能比较
PerformanceTests提供的性能测试比较：udp是http的5倍左右：
    performance(ms):write udp with batch of 1000 string:10
    performance(ms):write udp with 1000 single strings:20
    Single Point Write for 10000 writes of Points took:501.2 ms

为什么 UDP 有时比 TCP 更有优势
http://www.open-open.com/news/view/186415a

3、epid作为Measurement还是 Tag set，相同Measurement的数据是按Timestamp顺序读写的吗？

4、gzip对数据库容量的影响

5、数据如何切分

6、Time Series （时间序列）：你可以使用与时间有关的相关函数（如最大，最小，求和等）

7、如何做sharding