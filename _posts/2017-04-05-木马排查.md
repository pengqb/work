# 查看用户，删除不再使用的用户 #

    [root@vanelife-App11 ~]# cat /etc/passwd

# 查看可疑进程 #
    ps aux

# 进程的父进程 #

    ps -ef --forest

# 禁止使用wget #

	chmod a-x `which wget`


# 查看是否有非法的定时任务 #
crontab -e
    
# 查看最近被修改过的文件 #
## 查看命令用法 ##
找出 3 天"以前"被改动过的文件 (前第三天以前 → 2011/09/05 12:00 以前的文件) (> 72 小时)

	find /var/log/ -mtime +3 -print  

找出 3 天內被改动过的文件 (2011/09/05 12:00 ~ 2011/09/08 12:00 內的文件) (0 ~ 72 小时內)

	find /var/log/ -mtime -3 -print  

找出前第 3 天被改动过的文件 (2011/09/04 12:00 ~ 2011/09/05 12:00 內的文件) (72 ~ 96 小时)

	find /var/log/ -mtime 3 -print


## 查看最近修改过的文件 ##
主要查看以下几个地方的文件是否被修改过
格式如：

- find /etc/ -mtime -3 -print，
- find /bin/ -mtime -3 -print
- find /sbin/ -mtime -3 -print
- find /usr/bin/ -mtime -3 -print
- find /usr/sbin/ -mtime -3 -print
- find /var/log/ -mtime -3 -print
- find /etc/rc.d/ -mtime -30 -print 
- find /var/tmp/ -mtime -30 -print
- find /var/lib -mtime -30 -print
- ll -a / 


其中一些的启动文件都被修改过

    [root@vanelife-App01 rc0.d]# find /etc/rc.d/ -mtime -30 -print
    /etc/rc.d/rc6.d
    /etc/rc.d/rc6.d/K75cgconfig
    /etc/rc.d/rc6.d/K92iptables
    /etc/rc.d/rc6.d/K92ip6tables
    /etc/rc.d/rc6.d/K88sssd
    /etc/rc.d/rc6.d/K50mcelogd
    /etc/rc.d/rc4.d
    /etc/rc.d/rc4.d/K75cgconfig
    /etc/rc.d/rc4.d/K92iptables
    /etc/rc.d/rc4.d/K92ip6tables
    /etc/rc.d/rc4.d/K88sssd
    /etc/rc.d/rc4.d/K50mcelogd
    /etc/rc.d/rc3.d
    /etc/rc.d/rc3.d/K75cgconfig
    /etc/rc.d/rc3.d/K92iptables
    /etc/rc.d/rc3.d/S50mcelogd
    /etc/rc.d/rc3.d/K92ip6tables
    /etc/rc.d/rc3.d/K88sssd
    /etc/rc.d/rc2.d
    /etc/rc.d/rc2.d/K75cgconfig
    /etc/rc.d/rc2.d/K92iptables
    /etc/rc.d/rc2.d/K92ip6tables
    /etc/rc.d/rc2.d/K88sssd
    /etc/rc.d/rc2.d/K50mcelogd
    /etc/rc.d/rc1.d
    /etc/rc.d/rc1.d/K75cgconfig
    /etc/rc.d/rc1.d/K92iptables
    /etc/rc.d/rc1.d/K92ip6tables
    /etc/rc.d/rc1.d/K88sssd
    /etc/rc.d/rc1.d/K50mcelogd
    /etc/rc.d/rc0.d
    /etc/rc.d/rc0.d/K75cgconfig
    /etc/rc.d/rc0.d/K92iptables
    /etc/rc.d/rc0.d/K92ip6tables
    /etc/rc.d/rc0.d/K88sssd
    /etc/rc.d/rc0.d/K50mcelogd
    /etc/rc.d/rc5.d
    /etc/rc.d/rc5.d/K75cgconfig
    /etc/rc.d/rc5.d/K92iptables
    /etc/rc.d/rc5.d/S50mcelogd
    /etc/rc.d/rc5.d/K92ip6tables
    /etc/rc.d/rc5.d/K88sssd

## 查看可疑的定时任务 ##

ll /etc/cron*，其中Mar 23的文件都是木马

    [root@vanelife-App01 cron.hourly]# ll /etc/cron*
    -rw-------. 1 root root0 Nov 23  2013 /etc/cron.deny
    -rw-r--r--. 1 root root  457 Sep 27  2011 /etc/crontab
    
    /etc/cron.d:
    total 12
    -rw-r--r--. 1 root root 113 Nov 23  2013 0hourly
    -rw-r--r--. 1 root root 108 Apr  7  2014 raid-check
    -rw-r--r--. 1 root root 235 Aug 29  2014 sysstat
    
    /etc/cron.daily:
    total 32
    -rwxr-xr-x. 1 root root  118 Aug  6  2014 cups
    -rwxr-xr-x. 1 root root  196 Jul 18  2013 logrotate
    -rwxr-xr-x. 1 root root  905 Feb 22  2013 makewhatis.cron
    -rw-r--r--. 1 root root 2502 Mar 23 11:20 mlocate
    -rwxr-xr-x. 1 root root  174 Sep 24  2012 mlocate.cron
    -rwxr-xr-x. 1 root root 2126 Jul 19  2013 prelink
    -rwxr-xr-x. 1 root root  563 Nov 23  2013 readahead.cron
    -rwxr-xr-x. 1 root root 2867 Mar 23 11:20 tmpwatch
    
    /etc/cron.hourly:
    total 12
    -rwxr-xr-x. 1 root root  409 Nov 23  2013 0anacron
    -rw-r--r--. 1 root root 2502 Mar 23 11:20 gcc4.sh
    -rwxr-xr-x. 1 root root  273 Nov 22  2013 mcelog.cron
    
    /etc/cron.monthly:
    total 4
    -rwxr-xr-x. 1 root root 111 Nov 23  2013 readahead-monthly.cron
    
    /etc/cron.weekly:
    total 0

# 查看日志 #
查看/var/log/message日志，	系统启动后的信息和错误日志，是Red Hat Linux中最常用的日志之一 

	[root@vanelife-App04 log]# cd /var/log
    [root@vanelife-App04 log]# less messages

查看/var/log/cron日志	与定时任务相关的日志信息，通过下面的日志信息查看发现root用户被删除了。

    [root@vanelife-App04 log]# cd /var/log
    [root@vanelife-App04 log]# less cron
    [root@vanelife-App04 log]# less cron |grep DELETE
    Apr 10 13:39:30 vanelife-App04 crontab[28955]: (root) DELETE (root)
    Apr 10 14:07:09 vanelife-App04 crontab[43884]: (root) DELETE (root)
    Apr 10 14:17:09 vanelife-App04 crontab[49512]: (root) DELETE (root)
    Apr 10 14:45:08 vanelife-App04 crontab[64340]: (root) DELETE (root)
    Apr 10 14:56:08 vanelife-App04 crontab[5012]: (root) DELETE (root)
    Apr 10 15:05:10 vanelife-App04 crontab[9785]: (root) DELETE (root)
    Apr 11 01:20:15 vanelife-App04 crontab[37384]: (root) DELETE (root)
    Apr 11 03:26:01 vanelife-App04 crontab[48571]: (root) DELETE (root)

查看/var/log/secure日志，	与安全相关的日志信息 

	[root@vanelife-App04 log]# cd /var/log
    [root@vanelife-App04 log]# less secure

通过下面的日志发现不断尝试用root用户连接外面的服务器

    [root@vanelife-App04 log]# less secure |grep 'Failed password for root'
    Apr  9 13:04:40 vanelife-App04 sshd[58752]: Failed password for root from 10.0.0.11 port 34595 ssh2
    Apr  9 13:04:40 vanelife-App04 sshd[58752]: Failed password for root from 10.0.0.11 port 34595 ssh2
    Apr 10 13:41:41 vanelife-App04 sshd[30320]: Failed password for root from 10.0.0.12 port 53549 ssh2
    Apr 10 13:41:41 vanelife-App04 sshd[30320]: Failed password for root from 10.0.0.12 port 53549 ssh2

通过下面的日志发现/lib64/文件夹被删除了

	[root@vanelife-App04 log]#less secure |grep '/lib64/security'
    Apr 10 09:20:01 vanelife-App04 crond[37606]: PAM unable to dlopen(/lib64/security/pam_env.so): /lib64/security/pam_env.so: cannot open shared object file: No such file or directory
    Apr 10 09:20:01 vanelife-App04 crond[37606]: PAM adding faulty module: /lib64/security/pam_env.so
    Apr 10 09:20:01 vanelife-App04 crond[37606]: PAM unable to dlopen(/lib64/security/pam_deny.so): /lib64/security/pam_deny.so: cannot open shared object file: No such file or directory
    Apr 10 09:20:01 vanelife-App04 crond[37606]: PAM adding faulty module: /lib64/security/pam_deny.so

# audit审计 #

Linux VM Audit工具的使用案例说明如下：
=========================================
Linux audit测试： 
测试机器：CentOS6.5

    [root@vanelife-app2 ~]# cat /etc/issue
    CentOS release 6.5 (Final)
    Kernel \r on an \m

使用命令：service auditd status，查看audit服务是否已经开启，没有开启的话，请手动启动开启
我测试机器默认是开着的

    [root@vanelife-app2 ~]# service auditd status
    auditd (pid  50965) is running...

使用命令：vim /etc/audit/audit.rules，编辑audit的策略规则

    [root@vanelife-app2 ~]# vim /etc/audit/audit.rules

将如下命令加入到文件最底下：-w /etc/cron.daily/anacron -p w -k "anacronchange"
/etc/cron.daily/anacron为监控的文件，anacronchange为记录信息的关键字
    # Feel free to add below this line. See auditctl man page
    -w /etc/cron.daily/anacron -p w -k "anacronchange"

使用命令：service auditd restart，重启audit服务
    [root@vanelife-app2 ~]# service auditd restart
    Stopping auditd:   [  OK  ]
    Starting auditd:   [  OK  ]

使用命令：ausearch -i -k "anacronchange"，查看修改记录：

    type=CONFIG_CHANGE msg=audit(04/12/2017 18:40:43.474:985) : auid=root ses=79 op="updated rules" path=/etc/cron.daily/anacron key="anacronchange" list=exit res=1 
    ----
    type=CONFIG_CHANGE msg=audit(04/12/2017 19:52:10.143:1084) : auid=root ses=3 op="updated rules" path=/etc/cron.daily/anacron key="anacronchange" list=exit res=1 
    ----
    type=PATH msg=audit(04/12/2017 19:52:10.143:1085) : item=1 name=/etc/cron.daily/anacron inode=1189067 dev=08:01 mode=file,644 ouid=root ogid=root rdev=00:00 obj=unconfined_u:object_r:bin_t:s0 nametype=CREATE 
    type=PATH msg=audit(04/12/2017 19:52:10.143:1085) : item=0 name=/etc/cron.daily/ inode=1177581 dev=08:01 mode=dir,755 ouid=root ogid=root rdev=00:00 obj=system_u:object_r:bin_t:s0 nametype=PARENT 
    type=CWD msg=audit(04/12/2017 19:52:10.143:1085) :  cwd=/dev/shm 
    type=SYSCALL msg=audit(04/12/2017 19:52:10.143:1085) : arch=x86_64 syscall=open success=yes exit=4 a0=2549eb0 a1=241 a2=1b6 a3=0 items=2 ppid=21725 pid=22461 auid=root uid=root gid=root euid=root suid=root fsuid=root egid=root sgid=root fsgid=root tty=(none) ses=3 comm=wget exe=/usr/bin/wget subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="anacronchange" 

也可以使用命令：tail /var/log/audit/audit.log，进行查看

# 查看免密码登录 #

    [root@vanelife-App01 cron.hourly]# find /root/ -mtime -30 -print
    /root/.rediscli_history
    /root/.ssh/known_hosts
    /root/.ssh/authorized_keys
    /root/.bash_history

    cat /root/.ssh/authorized_keys
    AAAAB3NzaC1yc2EAAAABJQAAAIEAql4x2frt1MvlTlEF2JTmsXKLOc2bOJQticZscMJ+JK5ObOaSx182gO+kyfHlnBDbARs+pNVQvt1EaYqjorQfmiVDkZxim4FbzHeWfZ1JPjm9RdilH3zp6smkMKOjWjGeMRHzQtrvmfStbKcgmnzN2mvws6c8iGDi4c+YyXz7ocs=

修改免登录

    [root@vanelife-app1 .ssh]# rm -fr /root/.ssh/authorized_keys
    rm: cannot remove `/root/.ssh/authorized_keys': Operation not permitted
    [root@vanelife-app1 .ssh]# lsattr /root/.ssh/authorized_keys 
    ----i--------e- /root/.ssh/authorized_keys
    [root@vanelife-app1 .ssh]# chattr -i /root/.ssh/authorized_keys
    [root@vanelife-app1 .ssh]# rm -fr /root/.ssh/authorized_keys

# 使用木马病毒查杀工具 #

## 木马软件 ##
    yum install chkrootkit  
    chkrootkit

## 病毒软件 ##
    1.安装查杀
    yum install clamav
    2.下载病毒库
    freshclam
    3.扫描
    clamscan -r /home/mushme

# 服务器安全加固 #

1. 加固应用服务器密码。
1. 通过跳板机访问各服务器,关闭各服务器外网端口。
1. 跳板机ACL，只能从公司网址访问。

# 参考 #
    https://www.dwhd.org/20150908_191437.html?mType=Group