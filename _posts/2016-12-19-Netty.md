# 一、netty调优 #
## 1、最大句柄数修改   ##
长连接接入，首先需要优化的就是Linux内核参数，其中Linux最大文件句柄数是最重要的调优参数之一，默认单进程打开的最大句柄数是1024，通过ulimit -a可以查看相关参数，示例如下：

	[root@vane-turn01 log]# ulimit -a
	core file size          (blocks, -c) 0
	data seg size           (kbytes, -d) unlimited
	scheduling priority             (-e) 0
	file size               (blocks, -f) unlimited
	pending signals                 (-i) 112241
	max locked memory       (kbytes, -l) 64
	max memory size         (kbytes, -m) unlimited
	open files                      (-n) 1024
	......后续输出省略

当TCP链接超过1024上限后，就会报“too many open files”，所有新的客户端接入将失败。

通过vi /etc/security/limits.conf 添加如下配置参数：修改之后保存，注销当前用户，重新登录，通过ulimit -a 查看修改的状态是否生效。
    *  soft　　nofile　　1000000
    *  hard　　nofile　　1000000

需要指出的是，尽管我们可以将单个进程打开的最大句柄数修改的非常大，但是当句柄数达到一定数量级之后，处理效率将出现明显下降，因此，需要根据服务器的硬件配置和处理能力进行合理设置。如果单个服务器性能不行也可以通过集群的方式实现。/proc/sys/fs/file-max是系统给出的建议值，系统会计算资源给出一个和合理值，一般跟内存有关系，内存越大，该值越大，但是仅仅是一个建议值，limits.conf的设定完全可以超过/proc/sys/fs/file-max。

    [root@vanelife-mysql ~]# cat /proc/sys/fs/file-max
    1413492

## 2、网络对性能的影响 ##
本机跑rps=112307，跨局域网后，rps下降到35972。网络带宽400Mb
服务器和客户端在同一台机器，不跨网络跑的结果：
[root@vane-turn01 wrk]# ./wrk -t8 -c32 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 32 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency   354.14us  774.50us  34.96ms   95.74%
	    Req/Sec    14.11k     1.48k   17.92k    70.00%
	  Latency Distribution
	     50%  179.00us
	     75%  273.00us
	     90%  672.00us
	     99%    3.69ms
	  3372339 requests in 30.03s, 321.61MB read
	Requests/sec: 112307.33
	Transfer/sec:     10.71MB

跨局域网跑到结果：
[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     1.87ms    1.72ms  59.04ms   95.74%
	    Req/Sec     4.53k   449.89    11.23k    76.68%
	  Latency Distribution
	     50%    1.66ms
	     75%    1.98ms
	     90%    2.62ms
	     99%    6.10ms
	  1082684 requests in 30.10s, 103.25MB read
	Requests/sec:  35972.72
	Transfer/sec:      3.43MB

## 3、日志对性能的影响 ##
加一行日志后，本地和局域网内rps都将到17049左右
日志内容：

    2016-12-27 01:22:53.499|vane-turn01|info|nioEventLoopGroup-3-2|com.vela.iot.active.netty.http.HttpServerHandler|channelRead|rep=DefaultHttpRequest(decodeResult: success, version: HTTP/1.1)
    GET /rest/hello HTTP/1.1
    Host: 192.168.0.9:8080

[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     4.16ms    3.32ms  40.76ms   77.12%
	    Req/Sec     2.14k   364.32     3.19k    62.46%
	  Latency Distribution
	     50%    3.42ms
	     75%    5.55ms
	     90%    8.30ms
	     99%   15.92ms
	  511928 requests in 30.03s, 48.82MB read
	Requests/sec:  17049.91
	Transfer/sec:      1.63MB

使用异步日志后，性能恢复正常，跨局域网访问：
[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello
    Running 30s test @ http://192.168.0.9:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency 1.89ms2.05ms  69.00ms   96.62%
    	Req/Sec 4.57k   426.7511.63k77.55%
      Latency Distribution
     	50%1.64ms
    	75%1.97ms
     	90%2.63ms
     	99%6.34ms
      1091918 requests in 30.10s, 104.13MB read
    Requests/sec:  36275.92
    Transfer/sec:  3.46MB

本地访问

[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

    Running 30s test @ http://192.168.0.9:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency   848.59us2.52ms  95.95ms   97.11%
    	Req/Sec13.62k 1.67k   20.39k75.62%
      Latency Distribution
     	50%  417.00us
     	75%0.87ms
     	90%1.60ms
     	99%6.48ms
      3258688 requests in 30.09s, 310.77MB read
    Requests/sec: 108312.11
    Transfer/sec: 10.33MB



# 一、netty支持HTTP2 #
从以下位置下载netty-4.1.

    https://github.com/netty/netty/tree/netty-4.1.6.Final
依赖以下jar

	<dependency>
		<groupId>io.netty</groupId>
		<artifactId>netty-all</artifactId>
		<version>${netty.version}</version>
	</dependency>
	<dependency>
		<groupId>io.netty</groupId>
		<artifactId>netty-codec</artifactId>
		<version>${netty.version}</version>
	</dependency>



运行以下位置的Http2Server

    example\src\main\java\io\netty\example\http2\helloworld\server


运行java时，加上-Xbootclasspath/p:path 的JVM参数  让jvm优先于默认的bootstrap去加载path中指定的class。

    java -Xbootclasspath/p:c:/Users/pengqb/.m2/repository/org/mortbay/jetty/alpn/alpn-boot/8.1.9.v20160720/alpn-boot-8.1.9.v20160720.jar

不同的jdk版本需要使用不同的alpn-boot版本，见下面pom

	<profiles>
        <profile>
            <id>jdk-1.8.0</id>
            <activation>
                <jdk>1.8.0</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_05</id>
            <activation>
                <jdk>1.8.0_05</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_11</id>
            <activation>
                <jdk>1.8.0_11</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_20</id>
            <activation>
                <jdk>1.8.0_20</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_25</id>
            <activation>
                <jdk>1.8.0_25</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.2.v20141202</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_31</id>
            <activation>
                <jdk>1.8.0_31</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_40</id>
            <activation>
                <jdk>1.8.0_40</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_45</id>
            <activation>
                <jdk>1.8.0_45</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_51</id>
            <activation>
                <jdk>1.8.0_51</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.4.v20150727</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_60</id>
            <activation>
                <jdk>1.8.0_60</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.5.v20150921</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_65</id>
            <activation>
                <jdk>1.8.0_65</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.6.v20151105</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_66</id>
            <activation>
                <jdk>1.8.0_66</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.6.v20151105</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_71</id>
            <activation>
                <jdk>1.8.0_71</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_72</id>
            <activation>
                <jdk>1.8.0_72</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_73</id>
            <activation>
                <jdk>1.8.0_73</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_74</id>
            <activation>
                <jdk>1.8.0_74</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_77</id>
            <activation>
                <jdk>1.8.0_77</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_91</id>
            <activation>
                <jdk>1.8.0_91</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_92</id>
            <activation>
                <jdk>1.8.0_92</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.8.v20160420</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_101</id>
            <activation>
                <jdk>1.8.0_101</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_102</id>
            <activation>
                <jdk>1.8.0_102</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_111</id>
            <activation>
                <jdk>1.8.0_111</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_112</id>
            <activation>
                <jdk>1.8.0_112</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
    </profiles>

运行结果
https://127.0.0.1:8443/
Hello World - via HTTP/2

参考

    http://www.eclipse.org/jetty/documentation/current/alpn-chapter.html#alpn-starting
	http://jameswxx.iteye.com/blog/2096461