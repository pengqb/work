# 一、netty调优 #
## 1、最大句柄数修改   ##
长连接接入，首先需要优化的就是Linux内核参数，其中Linux最大文件句柄数是最重要的调优参数之一，默认单进程打开的最大句柄数是1024，通过ulimit -a可以查看相关参数，示例如下：

	[root@vane-turn01 log]# ulimit -a
	core file size          (blocks, -c) 0
	data seg size           (kbytes, -d) unlimited
	scheduling priority             (-e) 0
	file size               (blocks, -f) unlimited
	pending signals                 (-i) 112241
	max locked memory       (kbytes, -l) 64
	max memory size         (kbytes, -m) unlimited
	open files                      (-n) 1024
	......后续输出省略

当TCP链接超过1024上限后，就会报“too many open files”，所有新的客户端接入将失败。

通过vi /etc/security/limits.conf 添加如下配置参数：修改之后保存，注销当前用户，重新登录，通过ulimit -a 查看修改的状态是否生效。
    *  soft　　nofile　　1000000
    *  hard　　nofile　　1000000

需要指出的是，尽管我们可以将单个进程打开的最大句柄数修改的非常大，但是当句柄数达到一定数量级之后，处理效率将出现明显下降，因此，需要根据服务器的硬件配置和处理能力进行合理设置。如果单个服务器性能不行也可以通过集群的方式实现。/proc/sys/fs/file-max是系统给出的建议值，系统会计算资源给出一个和合理值，一般跟内存有关系，内存越大，该值越大，但是仅仅是一个建议值，limits.conf的设定完全可以超过/proc/sys/fs/file-max。

    [root@vanelife-mysql ~]# cat /proc/sys/fs/file-max
    1413492

## 2、网络对性能的影响 ##
本机跑rps=112307，跨局域网后，rps下降到35972。网络带宽400Mb
服务器和客户端在同一台机器，不跨网络跑的结果：
[root@vane-turn01 wrk]# ./wrk -t8 -c32 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 32 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency   354.14us  774.50us  34.96ms   95.74%
	    Req/Sec    14.11k     1.48k   17.92k    70.00%
	  Latency Distribution
	     50%  179.00us
	     75%  273.00us
	     90%  672.00us
	     99%    3.69ms
	  3372339 requests in 30.03s, 321.61MB read
	Requests/sec: 112307.33
	Transfer/sec:     10.71MB

跨局域网跑到结果：
[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     1.87ms    1.72ms  59.04ms   95.74%
	    Req/Sec     4.53k   449.89    11.23k    76.68%
	  Latency Distribution
	     50%    1.66ms
	     75%    1.98ms
	     90%    2.62ms
	     99%    6.10ms
	  1082684 requests in 30.10s, 103.25MB read
	Requests/sec:  35972.72
	Transfer/sec:      3.43MB

## 3、日志对性能的影响 ##
加一行日志后，本地和局域网内rps都将到17049左右
日志内容：

    2016-12-27 01:22:53.499|vane-turn01|info|nioEventLoopGroup-3-2|com.vela.iot.active.netty.http.HttpServerHandler|channelRead|rep=DefaultHttpRequest(decodeResult: success, version: HTTP/1.1)
    GET /rest/hello HTTP/1.1
    Host: 192.168.0.9:8080

[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     4.16ms    3.32ms  40.76ms   77.12%
	    Req/Sec     2.14k   364.32     3.19k    62.46%
	  Latency Distribution
	     50%    3.42ms
	     75%    5.55ms
	     90%    8.30ms
	     99%   15.92ms
	  511928 requests in 30.03s, 48.82MB read
	Requests/sec:  17049.91
	Transfer/sec:      1.63MB

使用异步日志后，性能恢复正常，跨局域网访问：

    nohup java -Xms4096m -Xmx4096m -Djava.rmi.server.hostname=192.168.0.9 -Dcom.sun.management.jmxremote.port=1090 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -Xbootclasspath/p:/app/netty/alpn-boot-8.1.9.v20160720.jar -jar authhttp2.jar >/dev/null &

[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello
    Running 30s test @ http://192.168.0.9:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency 1.89ms2.05ms  69.00ms   96.62%
    	Req/Sec 4.57k   426.7511.63k77.55%
      Latency Distribution
     	50%1.64ms
    	75%1.97ms
     	90%2.63ms
     	99%6.34ms
      1091918 requests in 30.10s, 104.13MB read
    Requests/sec:  36275.92
    Transfer/sec:  3.46MB

本地访问
[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

    Running 30s test @ http://192.168.0.9:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency   848.59us2.52ms  95.95ms   97.11%
    	Req/Sec13.62k 1.67k   20.39k75.62%
      Latency Distribution
     	50%  417.00us
     	75%0.87ms
     	90%1.60ms
     	99%6.48ms
      3258688 requests in 30.09s, 310.77MB read
    Requests/sec: 108312.11
    Transfer/sec: 10.33MB

## 4、异步日志、异步redis、异步mongo ##
包含异步日志、异步redis、异步mongo，redis、mongo和应用在同一局域网，在没有批量操作的情况下吞吐量能到27059.19。

mongodb的cpu=450。

redis的cpu=20。

java的cpu=650。

wrk的cpu=150。

curl -H "Content-type: application/json" -X POST -d '{"devSn":"add","devKey":"abc"}' http://192.168.18.138:8080/auth/gw/active
nohup java -Xms4096m -Xmx4096m -Djava.rmi.server.hostname=192.168.0.4 -Dcom.sun.management.jmxremote.port=1090 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -jar auth.jar 101001000000 >/dev/null &

[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     3.77ms    5.07ms  79.06ms   88.46%
	    Req/Sec     3.40k   563.84     5.30k    69.83%
	  Latency Distribution
	     50%    2.09ms
	     75%    4.55ms
	     90%    9.74ms
	     99%   24.32ms
	  813327 requests in 30.06s, 116.35MB read
	Requests/sec:  27059.19
	Transfer/sec:      3.87MB


## 5、UDP性能测试 ##
服务端启动命令

由于upd是无连接的，一个端口一个线程，所以第二个参数没有用。只有一个线程可以在一个UDP端口上接收数据并对其进行解码。所以UDP服务端只能跑一个cpu。
以下是单核服务器跑的性能，如果是多核的话，则性能×n。

    java -Xms8096m -Xmx8096m -Djava.rmi.server.hostname=10.217.90.82 -Dcom.sun.management.jmxremote.port=1090 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -jar authUDPServer.jar 000000000000 2 10485760

客户端启动命令

第四个参数没有用

    java -Xms8096m -Xmx8096m -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -jar authUDPClient.jar 10.217.90.82 1000000 100 2 10485760

服务器显示耗时
upd调用性能测试，无日志，耗时单位纳秒。

    第40200000次调用,累计耗时12540931
    第40210000次调用,累计耗时12306938
    第40220000次调用,累计耗时12249527
    第40230000次调用,累计耗时17192033
    第40240000次调用,累计耗时13739239
    第40250000次调用,累计耗时13043337
    第40260000次调用,累计耗时12520723
    第40270000次调用,累计耗时12760737
    第40280000次调用,累计耗时12697938
    第40290000次调用,累计耗时12611739
    第40300000次调用,累计耗时12581533
    第40310000次调用,累计耗时12687827
    第40320000次调用,累计耗时12562645

客户端显示耗时
总请求数:1000000,消费时间:12659123786纳秒

## 六、UDP性能优化 ##
**检查是否有丢包**

netstat -su

通过watch -n 1 -d 'netstat -su >> /app/netty/udpStats.txt'持续观察Udp的stats输出

- 输出里packets received的值指应用层从读入缓冲区里取走的包
- 输出里packets to unknown port received的值指端口无应用监听而分发至该端口的包
- 输出里packet receive errors的值指Udp接收错误数，正常情况下应该是0，在观察中不停增加，证明出现Udp包溢出接收缓冲区的情况
- 发生错误的包数与接收错误数非一一对应[3][4]

**观察Udp的dump**

通过watch -n 1 -d 'cat /proc/net/udp >> /usr/udpDump.txt'在发送数据的过程中持续观察Udp缓冲区的状况

- /proc/net/udp是瞬时的Udp socket dump，另有/proc/net/udp6用于监控IPv6
- dump输出里的tx_queue是发送缓冲区，rx_queue是接收缓冲区，单位都是byte
- 如果应用层收发效率足够好，正常情况下tx_queue和rx_queue两者永远是0
- 发送数据过程中频现rx_queue>0，说明Udp缓冲区有堆积现象[5][6]

**修改应用程序，服务器和客户端缓冲区大小**

    b.group(group).channel(NioDatagramChannel.class)
					.option(ChannelOption.SO_BROADCAST, true)
					.option(ChannelOption.SO_RCVBUF, 1024*2048)
					.option(ChannelOption.SO_SNDBUF, 1024*2048)

**修改Linux内核socket缓冲区大小**

查看内核socket缓冲区大小  
     
    cat /proc/sys/net/core/rmem_default
    cat /proc/sys/net/core/rmem_max

修改内核缓冲区大小 

    vi /etc/sysctl.conf
    net.core.rmem_default = 1048576
    net.core.rmem_max = 1048576
    net.core.wmem_default = 1048576
    net.core.wmem_max = 1048576

事参数生效
    sysctl -p

主要耗时部分在以下两部分，分配内存和网络写
    ByteBuf byteBuf = Unpooled.copiedBuffer(
    				"{\"pt\":\"fZud4fM6SUuvvvBoFyGNYw\",\"count\":" + count + "}",
    				CharsetUtil.UTF_8);
    				
    ctx.write(dp).addListener(listener);
    
    第19990次调用,bytebufTime2138,dpTime0,writeTime1711
    第19991次调用,bytebufTime2138,dpTime0,writeTime1283
    第19992次调用,bytebufTime2138,dpTime0,writeTime1711
    第19993次调用,bytebufTime2139,dpTime0,writeTime1283
    第19994次调用,bytebufTime2139,dpTime0,writeTime1710
    第19995次调用,bytebufTime2138,dpTime0,writeTime1711
    第19996次调用,bytebufTime2139,dpTime0,writeTime1710
    第19997次调用,bytebufTime2139,dpTime0,writeTime1283

进一步验证发现java读写map耗时如下
hashmap内存的读写速度

    第25次写入,累计耗时5132
    第26次写入,累计耗时4276
    第27次写入,累计耗时3848
    第28次写入,累计耗时5560
    第29次写入,累计耗时4704
    第30次写入,累计耗时4276
    第31次写入,累计耗时4704
    第32次写入,累计耗时4704
    第33次写入,累计耗时4704
    第34次写入,累计耗时4704
    第35次写入,累计耗时4276
    第36次写入,累计耗时4277
    
    第64次读,累计耗时1710
    第65次读,累计耗时1710
    第66次读,累计耗时1711
    第67次读,累计耗时1711
    第68次读,累计耗时1711
    第69次读,累计耗时1283
    第70次读,累计耗时1710
    第71次读,累计耗时2566
    第72次读,累计耗时1283
    第73次读,累计耗时1283
    第74次读,累计耗时1283
    第75次读,累计耗时1711

# 二、netty支持HTTP2 #
从以下位置下载netty-4.1.

    https://github.com/netty/netty/tree/netty-4.1.6.Final
依赖以下jar

	<dependency>
		<groupId>io.netty</groupId>
		<artifactId>netty-all</artifactId>
		<version>${netty.version}</version>
	</dependency>
	<dependency>
		<groupId>io.netty</groupId>
		<artifactId>netty-codec</artifactId>
		<version>${netty.version}</version>
	</dependency>



运行以下位置的Http2Server

    example\src\main\java\io\netty\example\http2\helloworld\server


运行java时，加上-Xbootclasspath/p:path 的JVM参数  让jvm优先于默认的bootstrap去加载path中指定的class。

    java -Xbootclasspath/p:c:/Users/pengqb/.m2/repository/org/mortbay/jetty/alpn/alpn-boot/8.1.9.v20160720/alpn-boot-8.1.9.v20160720.jar

不同的jdk版本需要使用不同的alpn-boot版本，见下面pom

	<profiles>
        <profile>
            <id>jdk-1.8.0</id>
            <activation>
                <jdk>1.8.0</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_05</id>
            <activation>
                <jdk>1.8.0_05</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_11</id>
            <activation>
                <jdk>1.8.0_11</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_20</id>
            <activation>
                <jdk>1.8.0_20</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.0.v20141016</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_25</id>
            <activation>
                <jdk>1.8.0_25</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.2.v20141202</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_31</id>
            <activation>
                <jdk>1.8.0_31</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_40</id>
            <activation>
                <jdk>1.8.0_40</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_45</id>
            <activation>
                <jdk>1.8.0_45</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.3.v20150130</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_51</id>
            <activation>
                <jdk>1.8.0_51</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.4.v20150727</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_60</id>
            <activation>
                <jdk>1.8.0_60</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.5.v20150921</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_65</id>
            <activation>
                <jdk>1.8.0_65</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.6.v20151105</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_66</id>
            <activation>
                <jdk>1.8.0_66</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.6.v20151105</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_71</id>
            <activation>
                <jdk>1.8.0_71</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_72</id>
            <activation>
                <jdk>1.8.0_72</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_73</id>
            <activation>
                <jdk>1.8.0_73</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_74</id>
            <activation>
                <jdk>1.8.0_74</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_77</id>
            <activation>
                <jdk>1.8.0_77</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_91</id>
            <activation>
                <jdk>1.8.0_91</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.7.v20160121</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_92</id>
            <activation>
                <jdk>1.8.0_92</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.8.v20160420</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_101</id>
            <activation>
                <jdk>1.8.0_101</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_102</id>
            <activation>
                <jdk>1.8.0_102</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_111</id>
            <activation>
                <jdk>1.8.0_111</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
        <profile>
            <id>jdk-1.8.0_112</id>
            <activation>
                <jdk>1.8.0_112</jdk>
            </activation>
            <properties>
                <alpn-boot.version>8.1.9.v20160720</alpn-boot.version>
            </properties>
        </profile>
    </profiles>

运行结果
https://127.0.0.1:8443/
Hello World - via HTTP/2

参考

    http://www.eclipse.org/jetty/documentation/current/alpn-chapter.html#alpn-starting
	http://jameswxx.iteye.com/blog/2096461

    [3]Udp Packet Receive Errors
    http://memoryboxes.github.io/blog/2016/05/20/udp-packet-receive-errors/
    [4]Udp packet drops and packet receive error difference
    https://linux-tips.com/t/udp-packet-drops-and-packet-receive-error-difference/237
    [5]How to monitor Linux UDP buffer available space?
    http://stackoverflow.com/questions/2289830/how-to-monitor-linux-udp-buffer-available-space/18322579#18322579
    [6]Meaning of fields in /proc/net/udp
    http://stackoverflow.com/questions/23753306/meaning-of-fields-in-proc-net-udp