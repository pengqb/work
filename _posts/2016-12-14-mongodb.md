# Install MongoDB Community Edition on linux #
安装位置 192.168.0.4 vanelife_mysql
## Configure the package management system (yum) ##
Create a `/etc/yum.repos.d/mongodb-org-3.4.repo` file so that you can install MongoDB directly, using yum.

Use the following repository file:

    [mongodb-org-3.4]
    name=MongoDB Repository
    baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
    gpgcheck=1
    enabled=1
    gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc

## 设置dns服务器 ##
命令行执行代码：

    vi /etc/resolv.conf

增加

    nameserver 8.8.8.8

## Install the MongoDB packages and associated tools ##

To install the latest stable version of MongoDB, issue the following command:

    sudo yum install -y mongodb-org


# Run MongoDB Community Edition #

## Configure SELinux ##
If you are using SELinux, you must configure SELinux to allow MongoDB to start on Red Hat Linux-based systems (Red Hat Enterprise Linux or CentOS Linux).
查看SELinux状态
    [root@vanelife-mysql ~]# sestatus -v
To configure SELinux, administrators have three options:


CentOS下安装semanage

    yum -y install policycoreutils-python

If SELinux is in enforcing mode, enable access to the relevant ports that the MongoDB deployment will use (e.g. 27017). See Default MongoDB Port for more information on MongoDB’s default ports. For default settings, this can be accomplished by running

    semanage port -a -t mongod_port_t -p tcp 27017

Disable SELinux by setting the SELINUX setting to disabled in /etc/selinux/config.

    SELINUX=disabled

You must reboot the system for the changes to take effect.
Set SELinux to permissive mode in /etc/selinux/config by setting the SELINUX setting to permissive.

    SELINUX=permissive

You must reboot the system for the changes to take effect.
You can instead use setenforce to change to permissive mode. setenforce does not require a reboot but is not persistent.

## Start MongoDB. ##
绑定指定ip，注释掉表示绑定所有ip
	vi /etc/mongod.conf

    bindIp: 192.168.0.4

You can start the mongod process by issuing the following command:

    sudo service mongod start


## Verify that MongoDB has started successfully ##
You can verify that the mongod process has started successfully by checking the contents of the log file at /var/log/mongodb/mongod.log for a line reading

    [initandlisten] waiting for connections on port <port>
where <port> is the port configured in /etc/mongod.conf, 27017 by default.

You can optionally ensure that MongoDB will start following a system reboot by issuing the following command:

    sudo chkconfig mongod on

## Stop MongoDB ##
As needed, you can stop the mongod process by issuing the following command:

    sudo service mongod stop

## Restart MongoDB. ##

You can restart the mongod process by issuing the following command:

    sudo service mongod restart


# Install MongoDB Community Edition on windows #
If you are running any edition of Windows Server 2008 R2 or Windows 7
please install a hotfix to resolve an issue with memory mapped files on Windows
下载位置 

    https://support.microsoft.com/zh-cn/kb/2731284

补丁程序我已经下载到本地

    Windows6.1-KB2731284-v3-x64.msu

# Start the mongo Shell #
To start the mongo shell and connect to your MongoDB instance running on localhost with default port:

    [root@vanelife-mysql ~]# mongo

显示正在使用的数据库

    > db

创建数据库

    > use iot

插入数据

    db.myCollection.insert( {method: "active",hashcode: 124555 } );
	db.getCollection("gw").insert( {method: "active",hashcode: 124555 } );

查询数据

    db.myCollection.find().pretty()

    {
    	"_id" : ObjectId("5880c8273d7198ff5d913c8c"),
    	"method" : "active",
    	"hashcode" : 124555
    }

修改数据

    db.myCollection.updateOne(
       { "_id": ObjectId("588156495586fa222db504d6") },
       {
     	$set: { "hashcode": 124666}
       }
    )


性能测试结果，更新数据，性能不乐观，且mongodb的cpu已经350左右。

    nohup java -Xms4096m -Xmx4096m -Djava.rmi.server.hostname=192.168.0.9 -Dcom.sun.management.jmxremote.port=1090 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -jar auth.jar 00010000 >/dev/null &

mongodb和应用在同一局域网，同步更新
[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello
    
	Running 30s test @ http://192.168.0.9:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency 4.46ms2.39ms  36.39ms   85.51%
    	Req/Sec 1.85k   327.72 2.86k66.25%
      Latency Distribution
     	50%3.69ms
     	75%5.58ms
     	90%7.26ms
     	99%   12.58ms
      443266 requests in 30.09s, 63.41MB read
    Requests/sec:  14729.70
    Transfer/sec:  2.11MB

mongodb和应用在同一台机器，同步更新
[root@vanelife-mysql wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.4:8080/rest/hello
    Running 30s test @ http://192.168.0.4:8080/rest/hello
      8 threads and 64 connections
      Thread Stats   Avg  Stdev Max   +/- Stdev
    	Latency 3.59ms1.88ms  53.49ms   82.95%
    	Req/Sec 2.30k   221.54 3.37k68.75%
      Latency Distribution
     	50%3.18ms
     	75%4.23ms
     	90%5.63ms
     	99%   10.26ms
      549862 requests in 30.03s, 78.66MB read
    Requests/sec:  18309.90
    Transfer/sec:  2.62MB
    [root@vanelife-mysql wrk]# 

mongodb和应用在同一局域网，同步批量（10条）更新，且mongodb的cpu已经550左右。throughput=9370.51×10

[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     6.86ms    3.18ms  62.92ms   79.90%
	    Req/Sec     1.19k   197.06     1.83k    67.72%
	  Latency Distribution
	     50%    5.77ms
	     75%    8.77ms
	     90%   10.91ms
	     99%   16.48ms
	  284056 requests in 30.10s, 40.63MB read
	Requests/sec:   9437.91
	Transfer/sec:      1.35MB

mongodb和应用在同一局域网，异步更新，且mongodb的cpu已经450左右。

[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello

	Running 30s test @ http://192.168.0.9:8080/rest/hello
	  8 threads and 64 connections
	  Thread Stats   Avg      Stdev     Max   +/- Stdev
	    Latency     2.92ms    4.34ms 132.82ms   89.91%
	    Req/Sec     4.52k   742.90     8.11k    69.29%
	  Latency Distribution
	     50%    1.58ms
	     75%    3.28ms
	     90%    7.32ms
	     99%   20.61ms
	  1079487 requests in 30.06s, 154.42MB read
	Requests/sec:  35912.15
	Transfer/sec:      5.14MB

mongodb和应用在同一局域网，异步批量（10条）更新，mongodb的cpu已经700左右。
throughput=26515.68×10
[root@vane-turn01 wrk]# ./wrk -t8 -c64 -d30s -T10s --latency http://192.168.0.9:8080/rest/hello
Running 30s test @ http://192.168.0.9:8080/rest/hello
  8 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.59ms    4.53ms  68.03ms   88.30%
    Req/Sec     3.33k   620.88     6.08k    68.42%
  Latency Distribution
     50%    2.12ms
     75%    4.32ms
     90%    9.05ms
     99%   21.38ms
  796478 requests in 30.04s, 113.94MB read
Requests/sec:  26515.68
Transfer/sec:      3.79MB